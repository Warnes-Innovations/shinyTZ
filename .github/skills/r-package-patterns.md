# Agent Skill: R Package Development Patterns

## Purpose
Guide structure, documentation, and testing practices for R package development following best practices and CRAN standards.

## When to Use
- Creating new R packages
- Adding functions to existing packages
- Writing package documentation
- Setting up package testing infrastructure
- Preparing packages for CRAN submission

## Package Structure

### Standard Layout

```
package-name/
├── DESCRIPTION          # Package metadata
├── NAMESPACE            # Exported functions (auto-generated by roxygen2)
├── README.md            # User-facing documentation
├── NEWS.md              # Version history and changelog
├── LICENSE              # License file
│
├── R/                   # R source code
│   ├── package.R        # Package-level documentation
│   ├── function1.R      # One exported function per file (preferred)
│   ├── function2.R      # File name matches function name
│   └── zzz.R            # .onLoad(), .onAttach() hooks
│
├── inst/                # Installed files (available at runtime)
│   ├── www/             # Web resources (JS, CSS, images)
│   ├── docs/            # Additional documentation
│   └── examples/        # Example scripts/apps
│
├── man/                 # Documentation (auto-generated from roxygen2)
│
├── tests/
│   └── testthat/        # Unit tests
│       ├── testthat.R   # Test runner
│       └── test-*.R     # Test files
│
├── vignettes/           # Long-form documentation
│
└── data/                # Package datasets (optional)
    └── dataset.rda
```

### File Naming Convention

**Best Practice:** One exported function per file, with the file name matching the function name.

```
R/
├── my_function.R        # Contains my_function()
├── another_function.R   # Contains another_function()
└── helper_functions.R   # Internal/unexported helpers can be grouped
```

**Why:**
- Easier navigation and discoverability
- Clear one-to-one mapping between files and functions
- Simplifies code reviews and maintenance
- Follows standard R package conventions (e.g., tidyverse, rstudio packages)

**Exceptions:**
- Internal/helper functions can be grouped in appropriately named files
- `.onLoad()`, `.onAttach()`, `.onUnload()` go in `zzz.R`
- Package-level documentation goes in `package.R`
- Very closely related functions (e.g., constructor + validator) may share a file

## Documentation with roxygen2

### Function Documentation Template

```r
#' One-line title describing the function
#'
#' More detailed description of what the function does, when to use it,
#' and any important context. Can span multiple paragraphs.
#'
#' Additional details about implementation, algorithms, or special cases.
#'
#' @param param1 Description of first parameter including expected type
#' @param param2 Description of second parameter with default behavior
#' @param optional Optional parameter (explain when to use)
#'
#' @return Description of return value including type and structure
#'
#' @export
#'
#' @examples
#' # Basic usage
#' result <- my_function("input", param2 = 10)
#'
#' # Advanced usage
#' result <- my_function("input", optional = TRUE)
#'
#' \dontrun{
#' # Example requiring external resources (won't run in R CMD check)
#' my_function(connect_to_database())
#' }
my_function <- function(param1, param2 = 5, optional = NULL) {
  # Implementation
}
```

### Package-Level Documentation

Create `R/package.R`:

```r
#' shinyTZ: Timezone-Aware Date and Time Rendering for Shiny
#'
#' Provides drop-in replacements for Shiny's text outputs that automatically
#' handle timezone conversion based on the user's browser timezone. Eliminates
#' the common problem of server timestamps being displayed in the wrong timezone
#' for remote users.
#'
#' @section Main functions:
#' \describe{
#'   \item{\code{\link{renderDatetime}}}{Render datetime with timezone awareness}
#'   \item{\code{\link{datetimeOutput}}}{UI element for datetime display}
#'   \item{\code{\link{get_browser_tz}}}{Get detected browser timezone}
#' }
#'
#' @docType package
#' @name shinyTZ-package
#' @aliases shinyTZ
#' @keywords internal
"_PACKAGE"

## usethis namespace: start
## usethis namespace: end
NULL
```

### Documentation Best Practices

1. **Use `\code{}`** for function names and code: `\code{renderDatetime()}`
2. **Use `\link{}`** for cross-references: `\code{\link{renderDatetime}}`
3. **Escape `%` in examples**: `format = "\%Y-\%m-\%d"` (not `%Y-%m-%d`)
4. **Use `\dontrun{}`** for examples requiring Shiny or databases
5. **Include return type**: Always document what the function returns
6. **Document all parameters**: Even obvious ones need brief description

### Generate Documentation

```r
# Update documentation and NAMESPACE
devtools::document()

# Check documentation
devtools::check_man()

# Build package website (if using pkgdown)
pkgdown::build_site()
```

## Unit Testing with testthat

### Test File Structure

```r
# tests/testthat/test-timezone-utils.R

test_that("format_in_tz handles timezone conversion correctly", {
  # Arrange: Create test data
  ts_utc <- as.POSIXct("2026-01-20 12:00:00", tz = "UTC")
  
  # Act: Run function
  result_ny <- format_in_tz(
    ts_utc,
    tz = "America/New_York",
    format = "%Y-%m-%d %H:%M %Z"
  )
  
  # Assert: Check result
  expect_equal(result_ny, "2026-01-20 07:00 EST")
})

test_that("format_in_tz handles NULL gracefully", {
  expect_equal(format_in_tz(NULL), "")
  expect_equal(format_in_tz(as.POSIXct(NA)), "")
})

test_that("format_in_tz validates input types", {
  expect_error(
    format_in_tz("not a datetime"),
    "requires POSIXct or POSIXlt"
  )
  
  expect_error(
    format_in_tz(123),
    "requires POSIXct or POSIXlt"
  )
})

test_that("format_in_tz handles multiple timezones", {
  ts <- as.POSIXct("2026-01-20 12:00:00", tz = "UTC")
  
  tz_tests <- list(
    list(tz = "America/New_York", expected = "07:00 EST"),
    list(tz = "Europe/London",    expected = "12:00 GMT"),
    list(tz = "Asia/Tokyo",       expected = "21:00 JST")
  )
  
  for (test in tz_tests) {
    result <- format_in_tz(ts, tz = test$tz, format = "%H:%M %Z")
    expect_equal(result, test$expected)
  }
})
```

### Test Coverage Goals

- **All exported functions**: 100% coverage
- **Critical internal functions**: >80% coverage
- **Edge cases**: NULL, NA, empty vectors, invalid inputs
- **Error handling**: Verify error messages
- **Integration**: Test interaction between functions

### Running Tests

```r
# Run all tests
devtools::test()

# Run specific test file
testthat::test_file("tests/testthat/test-timezone-utils.R")

# Check test coverage
covr::package_coverage()

# Interactive coverage report
covr::report()
```

## DESCRIPTION File

### Template

```
Package: shinyTZ
Type: Package
Title: Timezone-Aware Date and Time Rendering for Shiny
Version: 0.1.0
Authors@R: person("Gregory", "Warnes", 
                  email = "greg@example.com",
                  role = c("aut", "cre"),
                  comment = c(ORCID = "0000-0000-0000-0000"))
Description: Provides drop-in replacements for Shiny's text outputs that 
    automatically handle timezone conversion based on the user's browser 
    timezone. Eliminates the common problem of server timestamps being 
    displayed in the wrong timezone for remote users.
License: MIT + file LICENSE
Encoding: UTF-8
LazyData: true
Roxygen: list(markdown = TRUE)
RoxygenNote: 7.2.3
Depends: 
    R (>= 4.1.0)
Imports:
    shiny (>= 1.7.0),
    lubridate (>= 1.9.0),
    htmltools
Suggests:
    testthat (>= 3.0.0),
    knitr,
    rmarkdown,
    DBI,
    dplyr
VignetteBuilder: knitr
URL: https://github.com/username/shinyTZ
BugReports: https://github.com/username/shinyTZ/issues
```

### Key Fields

- **Depends**: R version and essential dependencies (user must have)
- **Imports**: Used by package code (auto-installed)
- **Suggests**: Optional dependencies (tests, vignettes, examples)
- **RoxygenNote**: Updated by `devtools::document()`
- **URL/BugReports**: GitHub links for help

## NAMESPACE Management

### Let roxygen2 Manage It

**Never edit NAMESPACE manually**. Use roxygen2 tags:

```r
#' @export          # Export function
#' @import package  # Import entire package
#' @importFrom package function  # Import specific function
#' @keywords internal  # Don't document (internal function)
```

### Common Imports

```r
#' @importFrom shiny reactive renderText
#' @importFrom lubridate with_tz
#' @importFrom htmltools HTML htmlEscape
```

## Package Initialization

### .onLoad() Hook

Use for one-time setup when package loads:

```r
# R/zzz.R

.onLoad <- function(libname, pkgname) {
  # Add resource path for JavaScript/CSS files
  shiny::addResourcePath(
    "shinytz",
    system.file("www", package = "shinytz")
  )
  
  # Set package options
  op <- options()
  op.shinytz <- list(
    shinytz.default_format = "%Y-%m-%d %H:%M:%S"
  )
  toset <- !(names(op.shinytz) %in% names(op))
  if (any(toset)) options(op.shinytz[toset])
  
  invisible()
}
```

### .onAttach() Hook

Use for startup messages (shown when library() is called):

```r
.onAttach <- function(libname, pkgname) {
  packageStartupMessage("shinyTZ: Timezone-aware Shiny components loaded")
}
```

## Package Checks

### Before Committing

```r
# Check documentation
devtools::document()

# Run tests
devtools::test()

# Full R CMD check
devtools::check()
```

### Common Check Warnings

**"no visible binding for global variable"**:
```r
# Add to R/globals.R or top of package.R
utils::globalVariables(c("variable_name", "another_var"))
```

**"S3 method not registered"**:
```r
#' @export
#' @method print myclass
print.myclass <- function(x, ...) {
  # Implementation
}
```

**"Undocumented code objects"**:
- Add `#' @keywords internal` to internal functions
- Or add `@export` to make them public

## Checklist

Before releasing package version:

- [ ] All functions documented with roxygen2
- [ ] All exported functions have @export tag
- [ ] Examples in documentation work
- [ ] DESCRIPTION file complete and accurate
- [ ] NEWS.md updated with changes
- [ ] All tests pass (devtools::test())
- [ ] R CMD check passes with no errors/warnings
- [ ] Test coverage >80% for new code
- [ ] README.md has installation instructions and examples
- [ ] Git commit messages follow conventions

## Common Mistakes

1. **Editing NAMESPACE manually** → Use roxygen2 @export tags
2. **Missing @export** → Function not available to users
3. **Unescaped % in examples** → Use `\%` in roxygen2 comments
4. **Missing imports** → Add @importFrom tags
5. **No return documentation** → Always document @return
6. **Insufficient test coverage** → Write tests for edge cases
7. **Missing \dontrun{}** → Examples requiring external resources fail R CMD check
